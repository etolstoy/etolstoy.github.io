<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      The Story of One Unit Test &middot; 
    
  </title>

  
    <meta name="description" content="What makes a clean test? Three things. Readability, readability, and readability." />
  

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/etolstoy.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="57x57" href="/public/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/public/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/public/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/public/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/public/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/public/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/public/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/public/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/public/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/public/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/public/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/public/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/public/icons/favicon-16x16.png">
  <link rel="shortcut icon" href="/public/icons/favicon.ico">
  <link rel="manifest" href="/public/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/public/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- Disqus -->
  <script id="dsq-count-scr" src="//etolstoy.disqus.com/count.js" async></script>
</head>


  <body class="theme-etolstoy">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="">
        <img src="http://www.gravatar.com/avatar/?s=130" class="image-circle" />
      </a>  
      <h1>
        <a href="">
          
        </a>
      </h1>
      <p class="lead">Egor Tolstoy personal page</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="">Blog</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/speaking/">Speaking</a>
          
        
      
        
      
        
      
      <a class="sidebar-nav-item" target="_blank" href="">GitHub</a>
      <a class="sidebar-nav-item" target="_blank" href="">LinkedIn</a>
    </nav>

    <span class="deprecated"><a href="http://etolstoy.ru/archive" target="_blank">RussianBlog __attribute__ ((deprecated))</a></span>
    <p>&copy; 2018. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
	    <div class="post">
  <h1 class="post-title">The Story of One Unit Test</h1>
  <span class="post-date">April 10, 2016</span>
  <blockquote>
  <p>What makes a clean test? Three things. Readability, readability, and readability. Readability is perhaps even more important in unit tests than it is in production code. What makes tests readable? The same thing that makes all code readable: clarity, simplicity, and density of expression. In a test you want to say a lot with as few expressions as possible.</p>
</blockquote>

<p><em>Robert Martin, Clean Code</em></p>

<p>It’s very easy to turn your unit tests into an unreadable and unmaintainable mess. The main reason of such attitude is a wrong understanding of test cases role. It’s not <em>“write once, never read”</em>. It’s not just in verifying your methods behaviour. Unit tests are all about documentation. It’s <em>“write once, refactor often, consult daily”</em>. The easier a test is, the more it tells to a developer.</p>

<!--more-->

<p>I won’t repeat all of Uncle Bob’s thoughts here. This post is meant to show how this rule of thumb can affect a real-world problem.</p>

<p>One of the key objects in LiveJournal application is <code class="highlighter-rouge">OperationScheduler</code>. It distributes <code class="highlighter-rouge">NSOperations</code> between multiple operation queues, handle their priority and does other related things. One of possible application usage scenarios is authorization token expiration. If we catch this error, we initiate token refresh by executing a corresponding operation. All pending data operations should be paused until the session is restored.</p>

<p>The easiest approach is making use of the <code class="highlighter-rouge">-addDependency</code> method. Pending data operations are dependent on token refresh operation. Our <code class="highlighter-rouge">OperationScheduler</code> implements this logic in few lines of code:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="n">NSOperation</span> <span class="o">*</span><span class="n">generalOperation</span> <span class="k">in</span> <span class="n">self</span><span class="p">.</span><span class="n">generalQueue</span><span class="p">.</span><span class="n">operations</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">generalOperation</span> <span class="nf">addDependency</span><span class="p">:</span><span class="n">operation</span><span class="p">];</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">authQueue</span> <span class="nf">addOperation</span><span class="p">:</span><span class="n">operation</span><span class="p">];</span>
</code></pre></div></div>

<p>But testing this behaviour is not that easy. To be sure everything works as expected, I’ve implemented the following test scenario:</p>

<ul>
  <li>The initial data operation is passed to a scheduler,</li>
  <li>5 other data operations are passed to the scheduler,</li>
  <li>This initial operation creates authorization operation on execute.</li>
</ul>

<p>If everything is fine, the sequence of operations is: 
<code class="highlighter-rouge">initial -&gt; authorization -&gt; general (x5)</code></p>

<p><a href="https://gist.github.com/etolstoy/dd9552a247df0b327abc898ddb8be5ad#file-operationschedulertests-1-m">The first revision</a> was not so great. Let’s explore it block by block.</p>

<p>The test should be asynchronyous. XCTestExpectation is the best option around.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">XCTestExpectation</span> <span class="o">*</span><span class="n">expectation</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">expectationWithDescription</span><span class="p">:</span><span class="s">@"Last operation fired"</span><span class="p">];</span>
</code></pre></div></div>

<p>The exact mechanism of creating an expectation is just an implementation detail, so we can safely hide it in a category and change this line to:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">XCTestExpectation</span> <span class="o">*</span><span class="n">expectation</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">expectationForCurrentTest</span><span class="p">];</span>
</code></pre></div></div>

<p>Each operation type has its identifier:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">kAuthOperationName</span> <span class="o">=</span> <span class="s">@"AuthOperation"</span><span class="p">;</span>
<span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">kInitialOperationName</span> <span class="o">=</span> <span class="s">@"InitialOperation"</span><span class="p">;</span>
<span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">kGeneralOperationName</span> <span class="o">=</span> <span class="s">@"GeneralOperation"</span><span class="p">;</span>
</code></pre></div></div>

<p>It’s not crucial to declare this constants right in the unit test body, so they can be safely moved to a separate file.</p>

<p>The <code class="highlighter-rouge">NSBlockOperation</code> syntax is really wordy:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NSBlockOperation</span> <span class="o">*</span><span class="n">authOperation</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSBlockOperation</span> <span class="nf">blockOperationWithBlock</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
        <span class="k">@synchronized</span><span class="p">(</span><span class="n">operationNames</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">[</span><span class="n">operationNames</span> <span class="nf">addObject</span><span class="p">:</span><span class="n">kAuthOperationName</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="p">[</span><span class="n">NSThread</span> <span class="nf">sleepForTimeInterval</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mo">05</span><span class="p">];</span>
    <span class="p">});</span>
<span class="p">}];</span>
</code></pre></div></div>

<p>The implementation of authorization and general operations is very straightforward - it just adds their identifiers to an array representing the call sequence. Once again, it’s just an implementation detail, so we can go forward and extract these operations somewhere else. However, the <code class="highlighter-rouge">initialOperation</code> is important for understanding what’s going on, so it shouldn’t be ignored. This results in an <code class="highlighter-rouge">Environment</code> class:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">TestBlockingByAuthOperationEnvironment</span> <span class="p">:</span> <span class="nc">NSObject</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setupEnvironmentWithTestCase</span><span class="p">:(</span><span class="n">XCTestCase</span> <span class="o">*</span><span class="p">)</span><span class="nv">testCase</span>
              <span class="nf">generalOperationsCount</span><span class="p">:(</span><span class="n">NSUInteger</span><span class="p">)</span><span class="nv">generalOperationsCount</span>
               <span class="nf">initialOperationBlock</span><span class="p">:(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="nv">initialOperationBlock</span><span class="p">;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSBlockOperation</span> <span class="o">*</span><span class="n">initialOperation</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSBlockOperation</span> <span class="o">*</span><span class="n">authOperation</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">generalOperations</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">firedOperationNames</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>This class encapsulates 60 lines of unimportant details. The operation setup can be refactored using cleaner syntax:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TestBlockingByAuthOperationEnvironment</span> <span class="o">*</span><span class="n">environment</span> <span class="o">=</span> <span class="p">[</span><span class="n">TestBlockingByAuthOperationEnvironment</span> <span class="nf">new</span><span class="p">];</span>
<span class="p">[</span><span class="n">environment</span> <span class="nf">setupEnvironmentWithTestCase</span><span class="p">:</span><span class="n">self</span>
                   <span class="nf">generalOperationsCount</span><span class="p">:</span><span class="n">kGeneralOperationsCount</span>
                    <span class="n">initialOperationBlock</span><span class="o">:^</span><span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">scheduler</span> <span class="nf">addAuthOperation</span><span class="p">:</span><span class="n">environment</span><span class="p">.</span><span class="n">authOperation</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">NSOperation</span> <span class="o">*</span><span class="n">operation</span> <span class="k">in</span> <span class="n">environment</span><span class="p">.</span><span class="n">generalOperations</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">scheduler</span> <span class="nf">addGeneralOperation</span><span class="p">:</span><span class="n">operation</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}];</span>
</code></pre></div></div>

<p>This is the last change - <code class="highlighter-rouge">// then</code> section is already simple and easy to understand.</p>

<p><a href="https://gist.github.com/etolstoy/dd9552a247df0b327abc898ddb8be5ad#file-operationschedulertests-1-m">The initial unit test</a> had 56 lines of code. <a href="https://gist.github.com/etolstoy/dd9552a247df0b327abc898ddb8be5ad#file-operationschedulertests-2-m">After refactoring</a> it’s shortened to 26 lines. What’s more important, the readability of the second version is certainly much greater. No more magic numbers, constants, ugly nested blocks and <code class="highlighter-rouge">@synchronized</code> directives - the next one who reads this file will focus on the test itself.</p>

  <br>
  <div class="twitter-promo">
	If you liked this post, you can <a href="https://twitter.com/intent/tweet?url=http://localhost:4000/2016/the-story-of-one-unit-test/&text=The Story of One Unit Test&via=igrekde" target="_blank"> share it with your followers</a> or <a href="https://twitter.com/igrekde" target="_blank"> follow me on Twitter</a>!
</div>
</div>

<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
        this.page.url = "http://localhost:4000/2016/the-story-of-one-unit-test/";
        this.page.identifier = "The Story of One Unit Test" ;
    };
    (function() {
        var d = document, s = d.createElement('script');
        
        s.src = '//etolstoy.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>  
    </div>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46769640-7', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
